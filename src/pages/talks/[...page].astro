---
import type { GetStaticPaths } from 'astro'
import Layout from '~/layouts/Layout.astro'
import PageHeader from '~/components/PageHeader.astro'
import Pagination from '~/components/Pagination.astro'
import TalksList from '~/components/TalksList.astro'
import siteConfig from '~/site.config'
import { getCollection } from 'astro:content'

export const getStaticPaths = (async () => {
  const allEntries = (await getCollection('talks'))
    .filter((e) => !e.data.draft)
    .sort((a, b) => b.data.published.getTime() - a.data.published.getTime())

  const pageSize = siteConfig.pageSize
  const totalPages = Math.ceil(allEntries.length / pageSize)

  return Array.from({ length: Math.max(0, totalPages - 1) }, (_, i) => {
    const pageNum = i + 2
    return {
      params: { page: [String(pageNum)] },
      props: { pageNum, totalPages },
    }
  })
}) satisfies GetStaticPaths

const { pageNum, totalPages } = Astro.props as { pageNum: number; totalPages: number }

const allEntries = (await getCollection('talks'))
  .filter((e) => !e.data.draft)
  .sort((a, b) => b.data.published.getTime() - a.data.published.getTime())

const pageSize = siteConfig.pageSize
const offset = (pageNum - 1) * pageSize
const entries = allEntries.slice(offset, offset + pageSize)

const prevLink = pageNum <= 2 ? '/talks' : `/talks/${pageNum - 1}`
const nextLink = pageNum < totalPages ? `/talks/${pageNum + 1}` : undefined

const pageTitle = `说说 - 第 ${pageNum} 页`
---

<Layout title={pageTitle} description="自言自语 / 碎碎念">
  <PageHeader />

  <section class="md:mx-2 mt-5">
    <div class="prose mb-4">
      <p>这里是一些随手记的碎碎念。</p>
    </div>

    {
      entries.length === 0 ? (
        <div class="prose">
          <p>这一页没有内容。</p>
        </div>
      ) : (
        <TalksList entries={entries} offset={offset} />
      )
    }

    <Pagination
      prevLink={prevLink}
      prevText="较新的说说"
      nextLink={nextLink}
      nextText="较早的说说"
    />
  </section>
</Layout>
