---
import Layout from '~/layouts/Layout.astro'
import PageHeader from '~/components/PageHeader.astro'
import { Image } from 'astro:assets'
import type { ImageMetadata } from 'astro'

const modules = import.meta.glob<{ default: ImageMetadata }>(
  '../gallery/**/*.{png,jpg,jpeg,webp,avif}',
  { eager: true },
)

function getAlbumKeyFromPath(path: string): string {
  const rel = path.replace('../gallery/', '')
  const parts = rel.split('/').filter(Boolean)
  return parts.length >= 2 ? parts[0] : 'default'
}

function getAltFromPath(path: string): string {
  const fileName = path.split('/').pop() ?? ''
  const baseName = fileName.replace(/\.[^.]+$/, '')
  return decodeURIComponent(baseName).replace(/[-_]+/g, ' ').trim() || '图片'
}

const albumMap = new Map<
  string,
  {
    album: string
    displayName: string
    count: number
    cover: ImageMetadata
    coverAlt: string
  }
>()

for (const [path, mod] of Object.entries(modules)) {
  const album = getAlbumKeyFromPath(path)
  const alt = getAltFromPath(path)

  const existing = albumMap.get(album)
  if (!existing) {
    albumMap.set(album, {
      album,
      displayName: album === 'default' ? '默认' : decodeURIComponent(album),
      count: 1,
      cover: mod.default,
      coverAlt: alt,
    })
  } else {
    existing.count += 1
  }
}

const albums = Array.from(albumMap.values()).sort((a, b) => {
  if (a.album === 'default' && b.album !== 'default') return -1
  if (a.album !== 'default' && b.album === 'default') return 1
  return a.displayName.localeCompare(b.displayName, 'zh-CN')
})
---

<Layout title="图库" description="瀑布流图片图库">
  <PageHeader />

  <section class="md:mx-2 mt-5">
    {
      albums.length === 0 ? (
        <div class="prose">
          <p>还没有找到图片。</p>
          <p>
            把图片放到 <code>src/gallery</code>（支持 png/jpg/jpeg/webp/avif）。
            你也可以在 <code>src/gallery</code> 下新建子文件夹来创建“子相册”。
          </p>
        </div>
      ) : (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {albums.map((a) => (
            <a
              href={`/gallery/${encodeURIComponent(a.album)}`}
              class="block rounded-xl border border-foreground/10 bg-foreground/5 hover:bg-foreground/7 transition-colors overflow-hidden">
              <Image
                src={a.cover}
                alt={a.coverAlt}
                loading="lazy"
                decoding="async"
                format="webp"
                quality={72}
                widths={[480, 960]}
                sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
                class="w-full aspect-[4/3] object-cover"
              />
              <div class="p-4">
                <div class="text-heading4 font-semibold text-accent">{a.displayName}</div>
                <div class="text-sm text-foreground/70 mt-1">{a.count} 张</div>
              </div>
            </a>
          ))}
        </div>
      )
    }
  </section>
</Layout>
